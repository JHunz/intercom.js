/*! intercom.js | https://github.com/diy/intercom.js | Apache License (v2) */ /*! This version forked at https://github.com/JHunz/intercom.js */
define(function(){var h=function(){};h.createInterface=function(a){return{on:function(b,c){"undefined"===typeof this[a]&&(this[a]={});this[a].hasOwnProperty(b)||(this[a][b]=[]);this[a][b].push(c)},off:function(b,c){"undefined"!==typeof this[a]&&this[a].hasOwnProperty(b)&&k.removeItem(c,this[a][b])},trigger:function(b){if("undefined"!==typeof this[a]&&this[a].hasOwnProperty(b))for(var c=Array.prototype.slice.call(arguments,1),d=0;d<this[a][b].length;d++)this[a][b][d].apply(this[a][b][d],c)}}};var p=
h.createInterface("_handlers");h.prototype._on=p.on;h.prototype._off=p.off;h.prototype._trigger=p.trigger;var q=h.createInterface("handlers");h.prototype.on=function(){q.on.apply(this,arguments);Array.prototype.unshift.call(arguments,"on");this._trigger.apply(this,arguments)};h.prototype.off=q.off;h.prototype.trigger=q.trigger;var f=window.localStorage;"undefined"===typeof f&&(f={getItem:function(){},setItem:function(){},removeItem:function(){}});var k={};k.guid=function(){var a=function(){return(65536*
(1+Math.random())|0).toString(16).substring(1)};return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}();k.throttle=function(a,b){var c=0;return function(){var d=(new Date).getTime();d-c>a&&(c=d,b.apply(this,arguments))}};k.extend=function(a,b){"undefined"!==typeof a&&a||(a={});if("object"===typeof b)for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a};k.removeItem=function(a,b){for(var c=b.length-1;0<=c;c--)b[c]===a&&b.splice(c,1);return b};var e=function(){var a=this,b=
(new Date).getTime();this.origin=k.guid();this.lastMessage=b;this.bindings=[];this.receivedIDs={};this.previousValues={};b=function(){a._onStorageEvent.apply(a,arguments)};window.attachEvent?document.attachEvent("onstorage",b):window.addEventListener("storage",b,!1)};e.prototype._transaction=function(a){var b=this,c=!1,d=!1,g=null,e=function(){if(!c){var t=(new Date).getTime(),u=parseInt(f.getItem(n)||0);u&&1E3>t-u?(d||(b._on("storage",e),d=!0),g=window.setTimeout(e,20)):(c=!0,f.setItem(n,t),a(),
d&&b._off("storage",e),g&&window.clearTimeout(g),f.removeItem(n))}};e()};e.prototype._cleanup_emit=k.throttle(100,function(){this._transaction(function(){for(var a=(new Date).getTime()-v,b=0,c=JSON.parse(f.getItem(l)||"[]"),d=c.length-1;0<=d;d--)c[d].timestamp<a&&(c.splice(d,1),b++);0<b&&f.setItem(l,JSON.stringify(c))})});e.prototype._cleanup_once=k.throttle(100,function(){var a=this;this._transaction(function(){var b,c=JSON.parse(f.getItem(m)||"{}");(new Date).getTime();var d=0;for(b in c)a._once_expired(b,
c)&&(delete c[b],d++);0<d&&f.setItem(m,JSON.stringify(c))})});e.prototype._once_expired=function(a,b){if(!b||!b.hasOwnProperty(a)||"object"!==typeof b[a])return!0;var c=b[a].ttl||w,d=(new Date).getTime();return b[a].timestamp<d-c};e.prototype._localStorageChanged=function(a,b){if(a&&a.key)return a.key===b;var c=f.getItem(b);if(c===this.previousValues[b])return!1;this.previousValues[b]=c;return!0};e.prototype._onStorageEvent=function(a){a=a||window.event;var b=this;this._localStorageChanged(a,l)&&
this._transaction(function(){for(var a=(new Date).getTime(),d=f.getItem(l),d=JSON.parse(d||"[]"),g=0;g<d.length;g++)if(!(d[g].origin===b.origin&&!0!==d[g].allowSelf||d[g].timestamp<b.lastMessage)){if(d[g].id){if(b.receivedIDs.hasOwnProperty(d[g].id))continue;b.receivedIDs[d[g].id]=!0}b.trigger(d[g].name,d[g].payload)}b.lastMessage=a});this._trigger("storage",a)};e.prototype._emit=function(a,b,c,d){if((d="string"===typeof d||"number"===typeof d?String(d):null)&&d.length){if(this.receivedIDs.hasOwnProperty(d))return;
this.receivedIDs[d]=!0}var g={id:d,name:a,origin:this.origin,timestamp:(new Date).getTime(),payload:b,allowSelf:c},e=this;this._transaction(function(){var c=f.getItem(l)||"[]",d="[]"===c?"":",",c=[c.substring(0,c.length-1),d,JSON.stringify(g),"]"].join("");f.setItem(l,c);g.origin==e.origin&&!0!==g.allowSelf||e.trigger(a,b);window.setTimeout(function(){e._cleanup_emit()},50)})};e.prototype.bind=function(a,b){for(var c=0;c<e.bindings.length;c++){var d=e.bindings[c].factory(a,b||null,this);d&&this.bindings.push(d)}};
e.prototype.emit=function(a,b,c){this._emit.apply(this,arguments);this._trigger("emit",a,b,c)};e.prototype.once=function(a,b,c){if(e.supported){var d=this;this._transaction(function(){var e=JSON.parse(f.getItem(m)||"{}");d._once_expired(a,e)&&(e[a]={},e[a].timestamp=(new Date).getTime(),"number"===typeof c&&(e[a].ttl=1E3*c),f.setItem(m,JSON.stringify(e)),b(),window.setTimeout(function(){d._cleanup_once()},50))})}};k.extend(e.prototype,h.prototype);e.bindings=[];e.supported="undefined"!==typeof f;
var l="intercom",m="intercom_once",n="intercom_lock",v=5E4,w=36E5;e.destroy=function(){f.removeItem(n);f.removeItem(l);f.removeItem(m)};e.getInstance=function(){var a=null;return function(){a||(a=new e);return a}}();var r=function(a,b,c){b=k.extend({id:null,send:!0,receive:!0},b);if(b.receive){var d=[],e=function(e,f){-1===d.indexOf(e)&&(d.push(e),a.on(e,function(a){var d="function"===typeof b.id?b.id(e,a):null,f="function"===typeof b.receive?b.receive(e,a):!0;(f||"boolean"!==typeof f)&&c._emit(e,
a,d)}))},f;for(f in c.handlers)for(var h=0;h<c.handlers[f].length;h++)e(f,c.handlers[f][h]);c._on("on",e)}b.send&&c._on("emit",function(c,d){var e="function"===typeof b.send?b.send(c,d):!0;(e||"boolean"!==typeof e)&&a.emit(c,d)})};r.factory=function(a,b,c){return"undefined"===typeof a.socket?!1:new r(a,b,c)};e.bindings.push(r);return e});
