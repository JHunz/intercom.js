/*! intercom.js | https://github.com/diy/intercom.js | Apache License (v2) */
define(function(){var g=function(){};g.createInterface=function(a){return{on:function(b,c){"undefined"===typeof this[a]&&(this[a]={});this[a].hasOwnProperty(b)||(this[a][b]=[]);this[a][b].push(c)},off:function(b,c){"undefined"!==typeof this[a]&&this[a].hasOwnProperty(b)&&h.removeItem(c,this[a][b])},trigger:function(b){if("undefined"!==typeof this[a]&&this[a].hasOwnProperty(b))for(var c=Array.prototype.slice.call(arguments,1),d=0;d<this[a][b].length;d++)this[a][b][d].apply(this[a][b][d],c)}}};var n=
g.createInterface("_handlers");g.prototype._on=n.on;g.prototype._off=n.off;g.prototype._trigger=n.trigger;var p=g.createInterface("handlers");g.prototype.on=function(){p.on.apply(this,arguments);Array.prototype.unshift.call(arguments,"on");this._trigger.apply(this,arguments)};g.prototype.off=p.off;g.prototype.trigger=p.trigger;var f=window.localStorage;"undefined"===typeof f&&(f={getItem:function(){},setItem:function(){},removeItem:function(){}});var h={};h.guid=function(){var a=function(){return(65536*
(1+Math.random())|0).toString(16).substring(1)};return function(){return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}}();h.throttle=function(a,b){var c=0;return function(){var d=(new Date).getTime();d-c>a&&(c=d,b.apply(this,arguments))}};h.extend=function(a,b){"undefined"!==typeof a&&a||(a={});if("object"===typeof b)for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a};h.removeItem=function(a,b){for(var c=b.length-1;0<=c;c--)b[c]===a&&b.splice(c,1);return b};var e=function(){var a=this,b=
(new Date).getTime();this.origin=h.guid();this.lastMessage=b;this.bindings=[];this.receivedIDs={};this.previousValues={};b=function(){a._onStorageEvent.apply(a,arguments)};window.attachEvent?document.attachEvent("onstorage",b):window.addEventListener("storage",b,!1)};e.prototype._transaction=function(a){var b=this,c=!1,d=!1,q=null,e=function(){if(!c){var s=(new Date).getTime(),t=parseInt(f.getItem(m)||0);t&&1E3>s-t?(d||(b._on("storage",e),d=!0),q=window.setTimeout(e,20)):(c=!0,f.setItem(m,s),a(),
d&&b._off("storage",e),q&&window.clearTimeout(q),f.removeItem(m))}};e()};e.prototype._cleanup_emit=h.throttle(100,function(){this._transaction(function(){for(var a=(new Date).getTime()-u,b=0,c=JSON.parse(f.getItem(k)||"[]"),d=c.length-1;0<=d;d--)c[d].timestamp<a&&(c.splice(d,1),b++);0<b&&f.setItem(k,JSON.stringify(c))})});e.prototype._cleanup_once=h.throttle(100,function(){var a=this;this._transaction(function(){var b,c=JSON.parse(f.getItem(l)||"{}");(new Date).getTime();var d=0;for(b in c)a._once_expired(b,
c)&&(delete c[b],d++);0<d&&f.setItem(l,JSON.stringify(c))})});e.prototype._once_expired=function(a,b){if(!b||!b.hasOwnProperty(a)||"object"!==typeof b[a])return!0;var c=b[a].ttl||v,d=(new Date).getTime();return b[a].timestamp<d-c};e.prototype._localStorageChanged=function(a,b){if(a&&a.key)return a.key===b;var c=f.getItem(b);if(c===this.previousValues[b])return!1;this.previousValues[b]=c;return!0};e.prototype._onStorageEvent=function(a){a=a||window.event;var b=this;this._localStorageChanged(a,k)&&
this._transaction(function(){for(var a=(new Date).getTime(),d=f.getItem(k),d=JSON.parse(d||"[]"),e=0;e<d.length;e++)if(!(d[e].origin===b.origin&&!0!==d[e].allowSelf||d[e].timestamp<b.lastMessage)){if(d[e].id){if(b.receivedIDs.hasOwnProperty(d[e].id))continue;b.receivedIDs[d[e].id]=!0}b.trigger(d[e].name,d[e].payload)}b.lastMessage=a});this._trigger("storage",a)};e.prototype._emit=function(a,b,c,d){if((d="string"===typeof d||"number"===typeof d?String(d):null)&&d.length){if(this.receivedIDs.hasOwnProperty(d))return;
this.receivedIDs[d]=!0}var e={id:d,name:a,origin:this.origin,timestamp:(new Date).getTime(),payload:b,allowSelf:c},g=this;this._transaction(function(){var c=f.getItem(k)||"[]",d="[]"===c?"":",",c=[c.substring(0,c.length-1),d,JSON.stringify(e),"]"].join("");f.setItem(k,c);g.trigger(a,b);window.setTimeout(function(){g._cleanup_emit()},50)})};e.prototype.bind=function(a,b){for(var c=0;c<e.bindings.length;c++){var d=e.bindings[c].factory(a,b||null,this);d&&this.bindings.push(d)}};e.prototype.emit=function(a,
b,c){this._emit.apply(this,arguments);this._trigger("emit",a,b,c)};e.prototype.once=function(a,b,c){if(e.supported){var d=this;this._transaction(function(){var e=JSON.parse(f.getItem(l)||"{}");d._once_expired(a,e)&&(e[a]={},e[a].timestamp=(new Date).getTime(),"number"===typeof c&&(e[a].ttl=1E3*c),f.setItem(l,JSON.stringify(e)),b(),window.setTimeout(function(){d._cleanup_once()},50))})}};h.extend(e.prototype,g.prototype);e.bindings=[];e.supported="undefined"!==typeof f;var k="intercom",l="intercom_once",
m="intercom_lock",u=5E4,v=36E5;e.destroy=function(){f.removeItem(m);f.removeItem(k);f.removeItem(l)};e.getInstance=function(){var a=null;return function(){a||(a=new e);return a}}();var r=function(a,b,c){b=h.extend({id:null,send:!0,receive:!0},b);if(b.receive){var d=[],e=function(e,f){-1===d.indexOf(e)&&(d.push(e),a.on(e,function(a){var d="function"===typeof b.id?b.id(e,a):null,f="function"===typeof b.receive?b.receive(e,a):!0;(f||"boolean"!==typeof f)&&c._emit(e,a,d)}))},f;for(f in c.handlers)for(var g=
0;g<c.handlers[f].length;g++)e(f,c.handlers[f][g]);c._on("on",e)}b.send&&c._on("emit",function(c,d){var e="function"===typeof b.send?b.send(c,d):!0;(e||"boolean"!==typeof e)&&a.emit(c,d)})};r.factory=function(a,b,c){return"undefined"===typeof a.socket?!1:new r(a,b,c)};e.bindings.push(r);return e});
